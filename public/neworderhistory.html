<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MealMate - Browse</title>
    <link rel="stylesheet" href="https://unicons.iconscout.com/release-pro/v4.0.0/css/line.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="assets/css/jquery.fancybox.min.css">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Firebase SDKs v9 (Modular approach) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCQaBzoODvEpUiqunlogkNjne8L-8UNZJk",
    authDomain: "wad2proj-f105e.firebaseapp.com",
    projectId: "wad2proj-f105e",
    storageBucket: "wad2proj-f105e.appspot.com",
    messagingSenderId: "154785765446",
    appId: "1:154785765446:web:765ccaaa71d2f5b68b5247"
        };

        // Initialize Firebase App
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // Vue.js Application
        const { createApp, ref, computed, onMounted } = Vue;

        const app = createApp({
            setup() {
                const email = ref('');
                const ordersData = ref([]);
                const current = ref(false);
                const selectedOrder = ref(null);
                const qrCodeUrl = ref(null);

                const filteredOrders = computed(() => {
                    return ordersData.value.filter(order => order.status === current.value);
                });

                // Fetch order history from Firestore
                const fetchOrderHistory = async () => {
                    const userPath = `userLogin/${email.value}/orderHistory/`;
                    const ordersRef = collection(db, userPath);
                    const querySnapshot = await getDocs(ordersRef);
                    ordersData.value = querySnapshot.docs.map(doc => ({
                        orderId: doc.id,
                        ...doc.data(),
                    }));
                };

                // Check authentication state
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        email.value = user.email;
                        await fetchOrderHistory();
                    } else {
                        redirectToLogin();
                    }
                });

                // Show orders based on status
                const showOrders = (status) => {
                    current.value = status;
                };

                const showOrderDetails = async (order) => {
                    selectedOrder.value = order;
                    if (!order.status) {
                        
                        const qrGenerator = new OrderQRGenerator();
                        qrCodeUrl.value = await qrGenerator.generateQR(order.orderId);
                    }
                };

                const backToHistory = () => {
                    selectedOrder.value = null;
                };

                // Redirect to login if user is not authenticated
                const redirectToLogin = () => {
                    window.location.href = "./login.html?mode=login";
                };

                // Order QR Generator class
                class OrderQRGenerator {
                    async generateQR(orderId) {
                        try {
                            const baseUrl = "https://wad2project.vercel.app//verify.html";
                            const verificationUrl = `${baseUrl}?orderID=${orderId}`;

                            const response = await axios.get(
                                "https://api.qrserver.com/v1/create-qr-code/",
                                {
                                    params: {
                                        data: verificationUrl,
                                        size: "100x100",
                                    },
                                    responseType: "blob",
                                }
                            );

                            const qrCodeUrl = URL.createObjectURL(response.data);
                            return qrCodeUrl;
                        } catch (error) {
                            console.error("Error generating QR code:", error);
                        }
                    }
                }

                return {
                    email,
                    ordersData,
                    current,
                    selectedOrder,
                    qrCodeUrl,
                    filteredOrders,
                    showOrders,
                    showOrderDetails,
                    backToHistory
                };
            }
        });

        app.mount('#app');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- Navbar Section -->
        <header class="site-header">
            <div class="container">
                <div class="row">
                    <div class="col-lg-2">
                        <div class="header-logo">
                            <a href="index.html">
                                <img src="./images/mealmate-logo-zip-file/png/logo-no-background.png" width="160" alt="Logo">
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-10">
                        <div class="main-navigation">
                            <button class="menu-toggle"><span></span><span></span></button>
                            <nav class="header-menu">
                                <ul class="menu food-nav-menu">
                                    <li><a href="#contact" @click="scrollToSection('contact')">Contact</a></li>
                                    <li><a href="./index.html" id="logout" class="nav-link">Log Out</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Order History Section -->
        <div id="viewport">
            <div id="js-scroll-content">
                <section class="section book-table bg-light repeat-img" style="background-image: url(assets/images/menu-bg.png);">
                    <div class="book-table-shape">
                        <img src="assets/images/table-leaves-shape.png" alt="shape">
                    </div>
                    <div class="book-table-shape book-table-shape2">
                        <img src="assets/images/table-leaves-shape.png" alt="shape">
                    </div>

                    <div class="sec-wp">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="sec-title text-center mb-5">
                                        <p class="sec-sub-title mb-3">Order History</p>
                                        <h2 class="h2-title">Please collect in time</h2>
                                    </div>
                                </div>
                            </div>

                            <div id="tabs" class="mb-3 d-flex justify-content-center">
                                <div id="pendingTab" class="tab active btn btn-primary mx-3" @click="showOrders(false)">Pending Orders</div>
                                <div id="finishedTab" class="tab btn btn-success" @click="showOrders(true)">Finished Orders</div>
                            </div>

                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="d-flex align-items-start">
                                        <!-- Order List Container -->
                                        <div id="ordersContainer" class="list-group flex-grow-1">
                                            <div v-for="order in filteredOrders" :key="order.orderId" class="list-group-item list-group-item-action" @click="showOrderDetails(order)">
                                                Store: {{ order.businessName }} - Order ID: {{ order.orderId }} - Total Price: ${{ order.amount }}
                                            </div>
                                        </div>

                                        <!-- Order Details Container (initially hidden) -->
                                        <div id="orderDetails" class="card ms-3 flex-grow-1" v-if="selectedOrder">
                                            <div class="card-body">
                                                <h1 class="mb-4">QR code</h1>
                                                <div class="qr-wrapper">
                                                    <img v-if="qrCodeUrl" :src="qrCodeUrl" class="qr-image" alt="QR Code" />
                                                </div>
                                                <h5>Order ID: {{ selectedOrder.orderId }}</h5>
                                                <p>Status: {{ selectedOrder.status ? 'Finished' : 'Pending' }}</p>
                                                <h6>Items Purchased:</h6>
                                                <ul>
                                                    <li v-for="item in selectedOrder.items" :key="item.name">{{ item.name }} - Price: ${{ item.price }}, Quantity: {{ item.quantity }}</li>
                                                </ul>
                                                <p>Total Price: ${{ selectedOrder.amount }}</p>
                                                <button class="btn btn-secondary mt-3" @click="backToHistory">Back to History</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

</body>
</html>
